const { handleSpaEvent } = require('../services/bitrix/spa1048Sync.v2');
const { verifyOutboundToken } = require('../services/bitrix/b24Outbound.v1');

function parseFromUrl(req) {
  const u = String(req.originalUrl || req.url || '');
  const qpos = u.indexOf('?');
  if (qpos < 0) return {};
  const qs = u.slice(qpos + 1);
  try {
    const sp = new URLSearchParams(qs);
    return {
      itemId: sp.get('itemId') || sp.get('id') || null,
      debug: sp.get('debug') || null,
    };
  } catch (_e) {
    return {};
  }
}

function extractItemId(req) {
  const q = req.query || {};
  const b = req.body || {};
  const fromUrl = parseFromUrl(req);

  const raw =
    q.itemId ?? q.id ??
    fromUrl.itemId ??
    b.itemId ?? b.id ??
    b?.data?.FIELDS?.ID ?? b?.data?.FIELDS?.id ??
    b?.FIELDS?.ID ?? b?.FIELDS?.id ??
    b?.data?.FIELDS_AFTER?.ID ?? b?.data?.FIELDS_AFTER?.id ??
    b?.data?.FIELDS_BEFORE?.ID ?? b?.data?.FIELDS_BEFORE?.id;

  const n = Number(String(raw ?? '').trim());
  return Number.isFinite(n) && n > 0 ? n : 0;
}

async function spaEvent(req, res) {
  try {
    // outbound secret: auth.application_token
    if (req.method === 'POST') {
      const tok = verifyOutboundToken(req, 'B24_OUTBOUND_SPA_TOKEN');
      if (!tok.ok) return res.status(403).json({ ok: false, error: tok.reason });
    }

    const itemId = extractItemId(req);
    if (!itemId) {
      console.log('[spa1048] ERROR: itemId is required');
      return res.status(400).json({ ok: false, error: 'itemId is required' });
    }

    // гарантируем itemId для сервиса
    req.query = req.query || {};
    req.query.itemId = String(itemId);

    return await handleSpaEvent(req, res);
  } catch (e) {
    const msg = e?.message || String(e);
    console.log('[spa1048] ERROR:', msg);
    return res.status(500).json({ ok: false, error: msg });
  }
}

module.exports = { spaEvent };
