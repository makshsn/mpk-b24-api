const { handleSpaEvent } = require('../services/bitrix/spa1048Sync.v2');
const { verifyOutboundToken } = require('../services/bitrix/b24Outbound.v1');

function extractItemId(req) {
  const q = req.query || {};
  const b = req.body || {};

  const raw =
    q.itemId ?? q.id ??
    b.itemId ?? b.id ??
    b?.data?.FIELDS?.ID ?? b?.data?.FIELDS?.id ??
    b?.FIELDS?.ID ?? b?.FIELDS?.id ??
    b?.data?.FIELDS_AFTER?.ID ?? b?.data?.FIELDS_AFTER?.id ??
    b?.data?.FIELDS_BEFORE?.ID ?? b?.data?.FIELDS_BEFORE?.id;

  const n = Number(String(raw ?? '').trim());
  return Number.isFinite(n) && n > 0 ? n : 0;
}

async function spaEvent(req, res) {
  try {
    // outbound secret: auth.application_token
    if (req.method === 'POST') {
      const tok = verifyOutboundToken(req, 'B24_OUTBOUND_SPA_TOKEN');
      if (!tok.ok) return res.status(403).json({ ok: false, error: tok.reason });
    }

    const itemId = extractItemId(req);
    if (!itemId) {
      console.log('[spa1048] ERROR: itemId is required');
      return res.status(400).json({ ok: false, error: 'itemId is required' });
    }

    // нормализуем, чтобы handleSpaEvent всегда видел itemId в query
    req.query = req.query || {};
    req.query.itemId = String(itemId);

    return await handleSpaEvent(req, res);
  } catch (e) {
    const msg = e?.message || String(e);
    console.log('[spa1048] ERROR:', msg);
    return res.status(500).json({ ok: false, error: msg });
  }
}

module.exports = { spaEvent };
