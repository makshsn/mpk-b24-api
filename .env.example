PORT=3000

# Базовый URL входящего вебхука Bitrix24 (без завершающего слеша)
# пример: https://b24-mg3u3i.bitrix24.ru/rest/1/xxxxxxxxxxxxxx
BITRIX_WEBHOOK_BASE=https://b24-mg3u3i.bitrix24.ru/rest/1/xxxxxxxxxxxxxx/

# Токен, чтобы твой эндпоинт не дёргали посторонние

BITRIX_TIMEOUT_MS=10000
BITRIX_RETRY_MAX=0

# === SPA 1048 invoices (deadline + task sync) ===
SPA1048_ENTITY_TYPE_ID=1048

# токен из исходящего вебхука (поле "Токен приложения")
B24_OUT_APP_TOKEN=xxxxxxxxxxxxxx

# кто ответственный в задаче (ID бухгалтера)
SPA1048_ACCOUNTANT_ID=70

# stageId списки через запятую:
# ACTIVE: Новый/В обработке/Срочно
SPA1048_STAGE_ACTIVE='DT1048_14:NEW','DT1048_14:PREPARATION','DT1048_14:CLIENT'
# FINAL: Успешно/Отмена
SPA1048_STAGE_FINAL='DT1048_14:SUCCESS','DT1048_14:FAIL'

SPA1048_STAGE_FAIL='DT1048_14:FAIL'

# Bitrix outbound tokens (per webhook)

# outbound tokens from Bitrix "Исходящий вебхук" (оба токена через запятую)
B24_OUTBOUND_TOKENS=xxxxxxxxxxxxxx,xxxxxxxxxxxxxx


# 24 раза в день
SPA1048_URGENT_INTERVAL_HOURS=1

# порог дней
SPA1048_URGENT_DAYS=3

# если название стадии отличается — укажи точное
SPA1048_URGENT_STAGE_NAME=Срочно к оплате

# если хочешь вообще без поиска по имени — укажи stageId напрямую
# пример: DT1048_14:UC_XXXXXXX
SPA1048_URGENT_STAGE_ID=DT1048_14:CLIENT

SPA1048_CATEGORY_ID=14

SPA1048_STAGE_PAID=DT1048_14:SUCCESS

SPA1048_FILES_FIELD_PAY_CAMEL=ufCrm8_1768219060503

SPA1048_CHECKLIST_POLL_MIN=5

SPA1048_DEBUG_ZIP=1
SPA1048_ZIP_TIMELINE=0
SPA1048_ZIP_DEBUG=1
LOG_LEVEL=debug
LOG_DIR=/var/www/mpk-b24-api/logs


# поле файлов
SPA1048_ENTITY_TYPE_ID=1048

# лимиты
SPA1048_FILES_MAX_FILES=200
SPA1048_FILES_MAX_PDF_MB=15
SPA1048_FILES_MAX_ZIP_MB=250

# если Bitrix не отдаст PARENT_ID у disk.file.get — задайте папку для upload сюда:
DISK_UPLOAD_FOLDER_ID=0
SPA1048_FILES_ENABLED=1

SPA1048_TASK_ID_FIELD_ORIG=UF_CRM_8_TASK_ID

TASK_EVENT_POLL_WINDOW_SEC=600
TASK_EVENT_POLL_LIMIT=50
TASK_EVENT_POLL_TTL_SEC=1200

#   xxxxxxxxxxxxxx

GMAIL_IMAP_HOST=imap.gmail.com
GMAIL_IMAP_PORT=993
GMAIL_IMAP_SECURE=true
GMAIL_IMAP_USER=xxxxxxxxxxxxxx@gmail.com
GMAIL_IMAP_PASS=xxxxxxxxxxxxxx

GMAIL_IMAP_MAILBOX=INBOX
GMAIL_IMAP_FETCH_LIMIT=10
GMAIL_IMAP_MARK_SEEN=Y
GMAIL_IMAP_INCLUDE_SOURCE=N


MAIL_STORE_DIR=/var/www/mpk-b24-api/var/mail_store
MAIL_STORE_KEEP_DAYS=30

# Сколько писем за один вызов парсить
GMAIL_IMAP_FETCH_LIMIT=10

# Помечать как прочитанные после успешного сохранения
GMAIL_IMAP_MARK_SEEN=Y
# В проде по умолчанию чистим всё тяжёлое после обработки
MAIL_STORE_DEBUG_KEEP=N          # Y = ничего не удаляем (для дебага)
MAIL_STORE_KEEP_TEXT_MINIMAL=Y   # Y = после обработки урезаем text/html, оставляем кратко
# Чанк загрузки файлов в SPA (если много вложений)
SPA1048_FILES_CHUNK=10
# Если нет вложений — прикрепить тело письма как файл (html/txt)
SPA1048_EMAIL_ATTACH_BODY_FILE=Y
# Лимиты на вложения при загрузке (в МБ)
SPA1048_EMAIL_MAX_FILE_MB=20
SPA1048_EMAIL_MAX_TOTAL_MB=60

# Разрешённые отправители (строго список email, через запятую)
MAIL_ALLOWED_FROM=xxxxxxxxxxxxxx,xxxxxxxxxxxxxx,xxxxxxxxxxxxxx,xxxxxxxxxxxxxx
# Что делать с письмами НЕ из allowlist
MAIL_SKIP_MARK_SEEN=N
MAIL_SKIP_LABEL=SKIPPED   # можно пусто, тогда метку не ставим
# Что делать с обработанными письмами
MAIL_PROCESSED_LABEL=PROCESSED  # можно пусто

# Автоворкер
MAIL_SPA1048_AUTORUN_ENABLED=Y
MAIL_SPA1048_INTERVAL_SEC=60
MAIL_SPA1048_RUN_LIMIT=10

MAIL_ALLOWED_EXT=pdf,doc,docx,xls,xlsx,xlsm

MAIL_SENDER_USER_MAP=xxxxxxxxxxxxxx=72,xxxxxxxxxxxxxx=36,xxxxxxxxxxxxxx=70,xxxxxxxxxxxxxx=16,xxxxxxxxxxxxxx=74


# --- SPA1048: автопересчёт "остатка к оплате" ---
# Включить/выключить джобу (Y/N)
SPA1048_REMAINING_ENABLED=Y

# Интервал запуска в секундах (по умолчанию 60)
SPA1048_REMAINING_INTERVAL_SEC=60

# Сколько элементов максимум обновлять за один тик (защита от больших объёмов)
SPA1048_REMAINING_UPDATE_LIMIT=50

# Тестовый режим: ничего не обновлять, только логировать (Y/N)
# SPA1048_REMAINING_DRY_RUN=Y


# --- Bitrix24 OAuth App (server-side local app, без UI) ---
# Портал (строго один, как ты указал)
B24_OAUTH_PORTAL=b24-mg3u3i.bitrix24.ru

# Client ID / Client Secret приложения (из настроек приложения в Битриксе)
B24_OAUTH_CLIENT_ID=xxxxxxxxxxxxxx
B24_OAUTH_CLIENT_SECRET=xxxxxxxxxxxxxx

# Публичная база твоего сервера (https, без слеша на конце)
# Именно сюда Bitrix24 будет слать install/event
B24_OAUTH_PUBLIC_BASE_URL=https://mpk-b24-webhooks.online

# Куда сохраняем токены/установку (по умолчанию: var/b24oauth_install.json)
# B24_OAUTH_STORE_PATH=/var/www/mpk-b24-api/var/b24oauth_install.json

# Таймауты (мс)
# B24_OAUTH_TIMEOUT_MS=30000

# OAuth endpoint (обычно не трогаем)
# B24_OAUTH_AUTH_ENDPOINT=https://oauth.bitrix.info/oauth/token/

# Redirect URI (должен совпадать с настройками приложения; по умолчанию удобнее ставить install URL)
B24_OAUTH_REDIRECT_URI=https://mpk-b24-webhooks.online/b24/oauth/install


MAIL_MARK_SKIPPED_SEEN=N
MAIL_SKIP_LABEL=SKIPPED

# обязательное ограничение по воронке
DEAL_PRODUCTION_CATEGORY_ID=0

# опционально (оставь как есть, если UF совпадают)
DEAL_LEAD_CONSTRUCTOR_FIELD=UF_CRM_1752671444
DEAL_SPEC_FILE_FIELD=UF_CRM_6877639A49D78
DEAL_CALC_FILE_FIELD=UF_CRM_687A05AF2793F

# антиспам (сек)
DEAL_FILES_MESSAGE_TTL_SEC=300

# просто “ожидаемый sender” для предупреждений в логах
DEAL_MESSAGE_SENDER_USER_ID=82
# (опционально) подсказка для логов
B24_WEBHOOK_USER_ID=82
