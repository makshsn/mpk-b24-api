# MPK B24 API — документация проекта

Проект: **mpk-b24-api** — Node.js сервис интеграции с Bitrix24 (облачная версия) для:
- приёма исходящих вебхуков Bitrix24;
- выполнения операций с лидами/контактами;
- автоматизации смарт‑процесса **SPA‑1048** (счета на оплату): задачи бухгалтеру, чеклисты, файлы, дедлайны, автопереносы стадий;
- периодических фоновых проверок (jobs/workers).

---

## 1) Как устроен проект

**Технологии**
- Node.js (CommonJS), Express.
- Вызовы Bitrix REST: через входящий вебхук (URL вида `.../rest/<user>/<token>`).
- Логи: JSON‑строки в stdout (удобно для PM2).

**Ключевые директории**
- `src/app.js`, `src/server.js` — запуск Express.
- `src/routes/*` — маршруты `/b24/*` и `/api/v1/bitrix/*`.
- `src/controllers/*` — тонкий слой HTTP-контроллеров.
- `src/services/bitrix/*` — вызовы Bitrix API и бизнес‑операции по лидам/контактам.
- `src/modules/spa1048/*` — логика смарт‑процесса SPA‑1048.
- `src/jobs/*` — периодические джобы (отдельные процессы под PM2/cron).
- `src/workers/*` — воркеры, которые постоянно крутятся в фоне.
- `.inspect/` — хранилище входящих запросов для отладки (см. раздел 6).

---

## 2) Запуск и деплой

### 2.1. Переменные окружения (.env)
Базово достаточно **трёх** переменных (см. `.env.example`):

- `PORT=3000` — порт сервиса.
- `BITRIX_WEBHOOK_BASE=https://<portal>/rest/<user>/<token>` — базовый URL входящего вебхука Bitrix24 (без завершающего `/`).
- `WEBHOOK_TOKEN=...` — общий токен защиты *внутренних/ручных* эндпоинтов (используется middleware `authWebhook`, если вы его подключите на нужные роуты).

> В проекте много опциональных переменных для SPA‑1048 и фоновых задач — они описаны в разделе 7.

### 2.2. Запуск локально
```bash
npm ci
cp .env.example .env
# заполнить .env
npm run start
# health-check
curl -s http://127.0.0.1:3000/health
```

### 2.3. Деплой на сервер (скрипт)
В корне есть `deploy.sh` — типовой сценарий:
- коммитит изменения (если есть),
- пушит,
- ставит зависимости (`npm ci --omit=dev`),
- рестартит `pm2` процесс `mpk-b24-api`.

Файл: `deploy.sh`.

---

## 3) HTTP эндпоинты

### 3.1. Публичные входящие вебхуки Bitrix24: `/b24/*`
Файл маршрутов: `src/routes/public.routes.js`

1) **SPA‑1048 event**
- `POST /b24/spa-event`
- `GET  /b24/spa-event` (для ручного теста)

Назначение: синхронизация карточки SPA‑1048 ↔ задача, обработка файлов/чеклистов, автодедлайн и т.п.  
Контроллер: `src/controllers/spa1048.controller.js`  
Логика: `src/modules/spa1048/spa1048Sync.v2.js`

2) **Событие “задача завершена/изменена” для SPA‑1048**
- `POST /b24/task-event`
- `GET  /b24/task-event`

Контроллер: `src/controllers/taskCompletionEvent.controller.js`  
Логика: `src/modules/spa1048/taskCompletionToSpa1048.v1.js`

Назначение (актуально):
- **ONTASKUPDATE → синхронизация дедлайна из задачи в SPA‑1048**
  - из задачи берётся `DEADLINE` (дата+время), приводится к формату `YYYY-MM-DD`;
  - в SPA обновляется поле **`UF_CRM_8_1768219591855`** (тип *дата*) — только если дата реально изменилась;
  - если задача не привязана к SPA‑1048 (`UF_CRM_TASK` не содержит `T418_<ID>`), синхронизация пропускается.
- **Завершение задачи**: при статусе задачи `STATUS=5` (completed) переводит элемент SPA‑1048 в стадию **SUCCESS** (оплачено),
  при этом не трогает элемент, если он уже в финальной “отмена/провалено” стадии.

Рекомендация по настройке Bitrix24: используйте **один** исходящий вебхук на `ONTASKUPDATE` → `https://.../b24/task-event`.
Не вешайте `ONTASKUPDATE` одновременно на несколько URL, чтобы не получить дубли и гонки.

3) **Webhook обновления задач (для SPA‑1048)**
- `POST /b24/task-update`
- `GET  /b24/task-update` (удобно тестировать руками)

Контроллер: `src/controllers/spa1048TaskUpdateWebhook.controller.js`  
Логика: `src/modules/spa1048/spa1048TaskOnUpdate.v1.js`

Статус: **не используется как основной входящий ONTASKUPDATE**. Исторически применялся для экспериментов/отладки.
В текущей схеме источник истины по обновлениям задач для SPA‑1048 — `/b24/task-event`.

Примечание: в актуальной конфигурации проекта основным входным событием по задачам SPA‑1048 является `/b24/task-event`.
`/b24/task-update` оставлен как отдельная точка входа/совместимость, но **не рекомендуется** одновременно подписывать Bitrix24 на оба.

4) **Закрытие задачи роботом (без изменения стадии SPA)**
- `POST /b24/task-close`
- `GET  /b24/task-close`
- `POST /b24/task-close/:taskId`
- `GET  /b24/task-close/:taskId`

Контроллер: `src/controllers/taskCloseWebhook.controller.js`  
Логика: `src/modules/tasks/taskCloseWebhook.v1.js`  
Назначение: “добить” задачу в статус *выполнена* (используется `tasks.task.complete`, при необходимости fallback на `tasks.task.approve`).

---

### 3.2. Внутреннее API: `/api/v1/bitrix/*`
Файл маршрутов: `src/routes/bitrix.routes.js`

1) **Создать/привязать контакт к лиду по телефону**
- `GET|POST /api/v1/bitrix/leads/:leadId/create-contact-by-phone`

Файлы:
- контроллер: `src/controllers/bitrix.controller.js`
- сервис: `src/services/bitrix/createContactFromLead.js`

Что делает (кратко):
- берёт телефон лида, нормализует до E.164;
- ищет дубликаты контактов по телефону (`crm.duplicate.findbycomm`);
- если контакт найден — привязывает к лиду;
- если нет — создаёт контакт, проставляет имя из TITLE лида (убирая телефоны из текста);
- при необходимости нормализует телефоны в лиде/контакте.

2) **Записать “текущий заказ” в контакт**
- `GET|POST /api/v1/bitrix/leads/:leadId/set-current-order-no`

Файлы:
- контроллер: `src/controllers/orderSimple.controller.js`
- сервис: `src/services/bitrix/setCurrentOrderNoFromLead.js`

Что делает:
- получает лид и связанный контакт (если контакта нет — пытается создать/привязать через сервис выше);
- берёт номер заказа из поля `UF_CRM_1754920390989` (1С);
- если номера нет — берёт TITLE лида и вычищает телефоны (fallback);
- пишет результат в поле контакта `UF_CRM_1755163800245` (“Текущие заказы”).

3) **Перенести “текущий заказ” в “закрытые” и очистить “текущий”**
- `GET|POST /api/v1/bitrix/leads/:leadId/move-current-to-closed`

Файлы:
- контроллер: `src/controllers/orderSimple.controller.js`
- сервис: `src/services/bitrix/moveCurrentToClosedFromLead.js`

Что делает:
- берёт номер заказа 1С из лида;
- берёт текущий текст заказа у контакта;
- добавляет/заменяет запись в “Закрытых заказах” (`UF_CRM_1755163819562`) в формате:  
  `"<старое название> -- <номер 1С>"`
- очищает поле “Текущие заказы”.

4) **Синхронизация “Пауза” по лидам (пакетом)**
- `GET|POST /api/v1/bitrix/leads/pause-sync?maxLeads=500&withIds=0&idLimit=200`

Файлы:
- контроллер: `src/controllers/pauseSync.controller.js`
- сервис: `src/services/bitrix/pauseSync.js`
- middleware: `src/middlewares/localOnly.js` (только localhost)

Назначение (кратко):
- обход лидов порциями с курсором (`var/pause_sync_cursor.json`);
- для каждого лида анализируется:
  - финальность (semantic != `P` пропускаем),
  - наличие задачи “Связаться с клиентом …” (по `UF_CRM_1753251930`),
  - просрочка дедлайна задачи (порог `CONTACT_TASK_OVERDUE_DAYS`, по умолчанию 3 дня),
  - заполненность “замера” (если задан — не трогаем),
  - предыдущая стадия и “разрешённость” перевода в паузу.
- если задача просрочена — переводит лид в стадию паузы `UC_79QMBF`, сохраняет предыдущую стадию в `UF_CRM_1760532085`, пишет причину паузы.
- если условия “паузы” больше не выполняются — может вернуть лид обратно на предыдущую стадию (если сохранена).

5) **Синхронизация “Пауза” (точечно по одному лиду)**
- `GET|POST /api/v1/bitrix/leads/:leadId/pause-sync`

Файлы:
- контроллер: `src/controllers/pauseSyncOne.controller.js`
- сервис: `src/services/bitrix/pauseSyncOne.js`
- middleware: `src/middlewares/localOnly.js`

Назначение: то же самое, но для одного лида (удобно отлаживать).

6) **Событие обновления задачи → синхронизация “даты следующего контакта” в лиде**
- `GET|POST /api/v1/bitrix/events/task-update`

Файлы:
- контроллер: `src/controllers/taskEvents.controller.js`
- сервис: `src/services/bitrix/syncNextContactFromTask.js`

Что делает:
- берёт `taskId` из тела/параметров события (учитывает разные форматы Bitrix);
- читает задачу;
- если задача по заголовку начинается с `CONTACT_TASK_TITLE_PREFIX` (“Связаться с клиентом…”),
  то берёт `DEADLINE` задачи и пишет в поле лида `UF_CRM_1753182274` (дата следующего контакта);
- защита от зацикливания: если дата уже совпадает — ничего не меняет.

Важно: этот эндпоинт относится к задачам лидов ("Связаться с клиентом...") и не является основным для SPA‑1048.
Для SPA‑1048 используйте `/b24/task-event` (см. раздел 3.1.2) и не дублируйте `ONTASKUPDATE` на несколько URL.

---

## 4) Автоматизация SPA‑1048 (счета на оплату)

### 4.1. Основной обработчик SPA‑событий: `spa1048Sync.v2`
Файл: `src/modules/spa1048/spa1048Sync.v2.js`  
Запускается через `/b24/spa-event`.

Ключевые действия при обработке карточки SPA‑1048:
1) **Гарантирует дедлайн оплаты**  
   Если поле дедлайна пустое — проставляет дефолтную дату (логика внутри модуля), обновляет `crm.item.update`.

2) **Привязывает/проверяет задачу по оплате**
   - читает `UF_CRM_8_TASK_ID` в SPA;
   - если задача удалена/завершена — может создать новую (см. `spa1048PaymentTask.v1`).

3) **Синхронизирует дедлайн SPA → дедлайн задачи**
   Если есть активная задача, и даты не совпадают — обновляет задачу (`tasks.task.update`).

   Обратная синхронизация (задача → SPA) выполняется обработчиком `/b24/task-event` на `ONTASKUPDATE`:
   - `DEADLINE` задачи (дата+время) приводится к `YYYY-MM-DD`;
   - обновляется `UF_CRM_8_1768219591855` (тип *дата*) только при реальном изменении даты.

4) **Файлы счёта**
   - если включено `SPA1048_FILES_ENABLED` (по умолчанию включено), выполняет нормализацию файлов:
     - распаковка ZIP,
     - выделение PDF,
     - ограничение размеров/кол-ва (настраивается env),
     - формирование “актуального списка файлов” (см. модуль файлов).

5) **Синхронизирует контент задачи (название/описание)**
   Обновляет задачу так, чтобы в ней было понятно:
   - какой это счёт (по карточке SPA),
   - какие файлы приложены,
   - какой дедлайн.

6) **Чеклист в задаче**
   Создаёт/обновляет чеклист (заголовки чеклиста управляются env).
   Логика: `src/modules/spa1048/taskChecklistSync.v1.js`.

7) **Автозакрытие/автоперенос стадии по чеклисту**
   В конце вызывает авто‑логику “закрыть задачу/перевести SPA”, если чеклист полностью выполнен
   (детали в модуле оплаты/чеклистов).

> Важно: внутри есть `withItemLock()` — защита от двойных действий на “залпе” вебхуков (одно SPA событие приходит несколько раз подряд).

---

### 4.2. Создание и сопровождение задачи оплаты: `spa1048PaymentTask.v1`
Файл: `src/modules/spa1048/spa1048PaymentTask.v1.js`

Назначение:
- создать задачу бухгалтеру, если её нет (или если старая задача уже завершена/неактуальна);
- поддерживать описание задачи в актуальном состоянии при изменениях файлов/дедлайна;
- управлять чеклистом и переходом SPA в финальную стадию.

Ключевые параметры:
- ответственный задачи: `SPA1048_ACCOUNTANT_ID` (по умолчанию 70);
- шаблон чеклиста: `SPA1048_CHECKLIST_TITLES` (если не задан — используются дефолтные пункты).

---

### 4.3. Перевод “в срочно к оплате” по дедлайну (джоба)
Файл логики: `src/modules/spa1048/spa1048UrgentToPay.js`  
Запуск:
- watcher: `src/jobs/spa1048UrgentWatcher.js` (постоянный процесс)
- run once: `src/jobs/spa1048UrgentRunOnce.js` (ручной одноразовый прогон)

Что делает:
- обходит все элементы SPA‑1048 (по всем категориям, либо по заданной категории);
- смотрит дату крайней оплаты (`deadlineField`);
- если до даты <= N дней (по умолчанию 3) — переводит в стадию “Срочно к оплате”;
- **не трогает**:
  - уже “Срочно к оплате”,
  - элементы с заполненной датой оплаты,
  - элементы на финальных стадиях (успех/провал/и любые перечисленные в `SPA1048_STAGE_FINAL`).

Интервал watcher:
- `SPA1048_URGENT_INTERVAL_HOURS` (по умолчанию 6 часов).

---

### 4.4. Воркёр: перенос SPA в “Оплачено” по статусу задачи
Файл: `src/workers/spa1048TaskStatusWatcher.worker.js`

Назначение:
- периодически обходит элементы SPA‑1048;
- для каждого элемента берёт связанный `taskId`;
- если задача в статусе “выполнена” (status=5) — переводит SPA в стадию “Оплачено” (`SPA1048_STAGE_PAID`);
- **игнорирует** элементы на финальных стадиях (`SPA1048_STAGE_FINAL`).

Интервал:
- `SPA1048_TASK_STATUS_WATCHER_INTERVAL_MS` (по умолчанию 1 час).

---

## 5) Безопасность входящих вебхуков

### 5.1. Application token (исходящие вебхуки Bitrix24)
Для `/b24/spa-event` (POST) включена проверка `application_token`:
- переменная: `B24_OUTBOUND_SPA_TOKEN`
- проверка: `src/services/bitrix/b24Outbound.v1.js` → `verifyOutboundToken()`

Если переменная не задана — проверка пропускается.

### 5.2. “Локальные” эндпоинты
Пакетные/сервисные методы (например `pause-sync`) ограничены middleware `localOnly` и доступны только с localhost.

---

## 6) Отладка: встроенный инспектор запросов

Маршруты инспектора подключены внутри `/b24` **до** debug middleware.  
Файл: `src/routes/inspect.routes.js`

- `POST /b24/_inspect/in` — сюда можно направить исходящий вебхук Bitrix24 “для посмотреть что реально прилетает”.
- `GET  /b24/_inspect/in` — проверка доступности.
- `GET  /b24/_inspect/list?n=20` — список последних запросов (мета).
- `GET  /b24/_inspect/last` — последний запрос целиком.
- `GET  /b24/_inspect/get/:id` — получить запрос по id.

Хранение:
- в памяти (быстро),
- на диске в `.inspect/` (переживает рестарт).
Настройки:
- `INSPECT_DIR`, `INSPECT_MAX`.

---

## 7) Полный список важных env‑настроек (практический справочник)

### 7.1. Общие
- `PORT` — порт сервера.
- `BITRIX_WEBHOOK_BASE` — базовый URL входящего вебхука.
- `BITRIX_TIMEOUT_MS` — таймаут Bitrix запросов (мс).
- `BITRIX_RETRY_MAX` — число ретраев при сетевых/лимитных ошибках.
- `BITRIX_LOG_MAX_STR` — ограничение длины строк в логах (маскирование/сжатие).
- `LOG_LEVEL`, `LOG_DIR` — если используете (логгер поддерживает параметры).

### 7.2. SPA‑1048 (ключевое)
- `SPA1048_ENTITY_TYPE_ID` — entityTypeId (по умолчанию 1048).
- `SPA1048_CATEGORY_ID` — если хотите ограничить обработку одной категорией.
- `SPA1048_ACCOUNTANT_ID` — ответственный задачи оплаты (по умолчанию 70).

**Стадии**
- `SPA1048_STAGE_PAID` / `SPA1048_STAGE_SUCCESS` — финальная стадия “оплачено” (по умолчанию `DT1048_14:SUCCESS`).
- `SPA1048_STAGE_FAIL` / `SPA1048_STAGE_FAILURE` — финальная стадия “fail” (по умолчанию `DT1048_14:FAIL`).
- `SPA1048_STAGE_FINAL` — *любые* финальные стадии списком через запятую (дополняет success/fail).  
  Пример: `SPA1048_STAGE_FINAL=DT1048_14:SUCCESS,DT1048_14:FAIL`

**Срочно к оплате (urgent)**
- `SPA1048_URGENT_INTERVAL_HOURS` — период джобы, часы (по умолчанию 6).
- `SPA1048_URGENT_DAYS` — порог “сколько дней осталось” (по умолчанию 3).
- `SPA1048_URGENT_STAGE_NAME` — название стадии (“Срочно к оплате”), если ищем по имени.
- `SPA1048_URGENT_STAGE_ID` — если хотите жёстко задать stageId и не искать по имени.

**Файлы**
- `SPA1048_FILES_ENABLED` — `0/1` (по умолчанию включено).
- `SPA1048_FILES_MAX_FILES`, `SPA1048_FILES_MAX_FILE_MB`, `SPA1048_FILES_MAX_PDF_MB`, `SPA1048_FILES_CHUNK`, `SPA1048_FILES_COMMENT_TTL_SEC` — ограничения/поведение для нормализации файлов.

**Задачи**
- `SPA1048_TASK_ID_FIELD_ORIG` — UF поле, где хранится taskId (по умолчанию `UF_CRM_8_TASK_ID`).
- `SPA1048_TASK_ID_FIELD_CAMEL` — если на портале возвращается альтернативный camelCase ключ.
- `SPA1048_TASK_STATUS_WATCHER_INTERVAL_MS` — интервал воркера статуса задач.
- `SPA1048_TASK_STATUS_WATCHER_PAGE_SIZE`, `SPA1048_TASK_STATUS_WATCHER_MAX_PAGES` — ограничения обхода (страницы).

**Чеклист**
- `SPA1048_CHECKLIST_TITLES` — пункты чеклиста через запятую.
- `TASK_FILES_CHECKLIST_TITLE`, `TASK_PDF_CHECKLIST_TITLE` — кастомные названия секций чеклиста (если используются).

### 7.3. Токены исходящих вебхуков
- `B24_OUTBOUND_SPA_TOKEN` — проверка `application_token` для `/b24/spa-event`.
- `B24_TASK_OUT_TOKEN` — если включите аналогичную проверку для задач (в коде предусмотрены хуки извлечения токена).

---

## 8) Типовые сценарии использования

### 8.1. Подключение исходящего вебхука Bitrix24 на SPA‑1048
- URL: `https://<ваш-домен>/b24/spa-event`
- метод: POST
- при необходимости включить проверку `application_token`:
  - задать `B24_OUTBOUND_SPA_TOKEN` на сервере,
  - указать тот же `application_token` в настройке исходящего вебхука Bitrix24.

### 8.2. Проверка, что событие реально приходит
1) Отправьте тестовый POST в инспектор:
   - `POST /b24/_inspect/in`
2) Откройте:
   - `GET /b24/_inspect/last`

### 8.3. Ручной прогон “Срочно к оплате”
На сервере:
```bash
node src/jobs/spa1048UrgentRunOnce.js
```

---

## 9) Где “истина” по бизнес‑логике
Если нужно быстро понять, что именно делает автоматизация — в первую очередь смотрите:
- SPA‑1048 обработка: `src/modules/spa1048/spa1048Sync.v2.js`
- Задачи/чеклисты/переходы: `src/modules/spa1048/spa1048PaymentTask.v1.js`, `src/modules/spa1048/taskChecklistSync.v1.js`
- Срочность по дедлайну: `src/modules/spa1048/spa1048UrgentToPay.js`
- Перенос в оплачено по задаче: `src/workers/spa1048TaskStatusWatcher.worker.js`
- Пауза по лидам: `src/services/bitrix/pauseSync.js`



## 10) Резервные/пока не подключённые части (есть в коде, но не в роутинге)
Иногда в проекте лежат модули “на будущее” или оставшиеся после рефакторинга. На текущий момент в `routes/*` они **не подключены**, но код существует:

- `src/controllers/orderMove.controller.js` + `src/services/bitrix/moveLeadOrderToClosed.js` — альтернативная логика переноса заказа лида в “закрытые” (в роуты сейчас не заведено).
- `src/middlewares/authWebhook.js` — простая защита по `WEBHOOK_TOKEN` (используйте, если захотите закрыть часть публичных эндпоинтов общим токеном).
- `src/middlewares/bitrixOutboundGuard.js` — заготовка под более строгую защиту исходящих вебхуков (если решите расширять модель безопасности).

Если эти куски не нужны — их можно безопасно удалить после проверки, что нигде не импортируются.
